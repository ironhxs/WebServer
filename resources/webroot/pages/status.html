<!DOCTYPE html>
<!--
  status.html - 服务器状态监控页面
  
  功能:
  - 实时显示服务器运行状态
  - 每2秒自动刷新数据
  
  显示指标:
  - 运行时长: 服务器启动后的运行时间
  - 在线用户: 当前唯一IP数
  - 活跃连接: 当前TCP连接数
  - 累计访客: 历史唯一IP数
  - 请求总数: 总请求量
  - 平均QPS: 每秒请求数
  - 服务器时间: 当前服务器时间
  
  与后端交互:
  - GET /status.json: 获取JSON格式的状态数据
-->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="/assets/media/favicon.ico">
    <link rel="stylesheet" href="/assets/css/site.css">
    <title>WebServer | 监控</title>
</head>
<body>
<div class="page">
<div class="nav">
    <div class="brand">WebServer 实验站</div>
    <div class="nav-links">
        <a href="/">首页</a>
        <a href="/uploads/list">我的上传</a>
        <a href="/pages/status.html">监控</a>
    </div>
    <div class="nav-auth">
        <a class="btn ghost" href="/pages/log.html">登录</a>
        <a class="btn primary" href="/pages/register.html">注册</a>
    </div>
</div>
<section class="panel" style="max-width: 860px; margin: 0 auto;">
    <h2 style="font-size: 26px;">运行监控</h2>
    <p style="color: var(--muted); margin-top: 10px;">实时查看服务运行状态与统计信息。</p>
    <div class="grid" style="margin-top: 18px;">
        <div class="card"><h3>运行时长</h3><p id="uptime">-</p></div>
        <div class="card"><h3>在线用户</h3><p id="online-users">-</p></div>
        <div class="card"><h3>活跃连接</h3><p id="online-connections">-</p></div>
        <div class="card"><h3>累计访客</h3><p id="total-visitors">-</p></div>
        <div class="card"><h3>请求总数</h3><p id="total">-</p></div>
        <div class="card"><h3>平均 QPS</h3><p id="qps">-</p></div>
        <div class="card"><h3>服务器时间</h3><p id="time">-</p></div>
    </div>
    <div class="actions" style="margin-top: 22px;">
        <a class="btn primary" href="/status.json">查看 JSON</a>
    </div>
</section>
</div>
<script>
/**
 * 状态更新函数
 * 
 * 工作流程:
 * 1. 使用fetch API请求/status.json
 * 2. 解析JSON响应
 * 3. 更新页面各个指标元素
 * 
 * JSON响应格式:
 * {
 *   "uptime_seconds": 3600,        // 运行秒数
 *   "online_users": 10,            // 在线用户数
 *   "online_connections": 5,       // 活跃连接数
 *   "total_unique_visitors": 100,  // 累计访客
 *   "total_requests": 1000,        // 请求总数
 *   "avg_qps": 0.28,               // 平均QPS
 *   "server_time": "2026-01-12 10:30:00"  // 服务器时间
 * }
 */
const updateStatus = () => {
    fetch('/status.json').then(r => r.json()).then(data => {
        // 将秒数转换为 时:h 分:m 秒:s 格式
        const sec = data.uptime_seconds || 0;
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = sec % 60;
        document.getElementById('uptime').textContent = `${h}h ${m}m ${s}s`;
        // 在线用户 = 唯一IP数量（考虑了Cloudflare穿透）
        document.getElementById('online-users').textContent = data.online_users || 0;
        // 活跃连接 = TCP连接数
        document.getElementById('online-connections').textContent = data.online_connections || 0;
        // 累计访客 = 历史唯一IP总数
        document.getElementById('total-visitors').textContent = data.total_unique_visitors || 0;
        document.getElementById('total').textContent = data.total_requests;
        const qps = typeof data.avg_qps === 'number' ? data.avg_qps : 0;
        document.getElementById('qps').textContent = qps.toFixed(2);
        document.getElementById('time').textContent = data.server_time;
    }).catch(() => {
        document.getElementById('uptime').textContent = '获取失败';
    });
};
updateStatus();
setInterval(updateStatus, 2000);
</script>
<script src="/assets/js/nav-auth.js"></script>
</body>
</html>
